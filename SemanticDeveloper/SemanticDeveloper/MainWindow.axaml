<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SemanticDeveloper"
        xmlns:models="clr-namespace:SemanticDeveloper.Models"
        xmlns:ae="clr-namespace:AvaloniaEdit;assembly=AvaloniaEdit"
        mc:Ignorable="d" d:DesignWidth="1100" d:DesignHeight="720"
        x:Class="SemanticDeveloper.MainWindow"
        x:CompileBindings="False"
        Title="Semantic Developer"
        Icon="avares://SemanticDeveloper/Images/semantic-developer-logo-large.png"
        WindowState="Maximized">
    <Grid RowDefinitions="Auto,*" ColumnDefinitions="*">
        <!-- Top toolbar -->
        <Border Background="#2B2B2B" Padding="12">
            <Grid ColumnDefinitions="Auto,12,*,Auto,8,Auto,12,Auto,8,Auto,8,Auto">
                <Button x:Name="SelectWorkspaceButton" Foreground="#E6E6E6" Click="OnSelectWorkspaceClick">Select Workspace…</Button>
                <Border Grid.Column="1"/>
                <TextBlock Grid.Column="2" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" Foreground="#E6E6E6">
                    <Run Text="Workspace: "/>
                    <Run Text="{Binding CurrentWorkspacePath}"/>
                </TextBlock>
                <TextBlock Grid.Column="3" VerticalAlignment="Center" Foreground="#E6E6E6" IsVisible="{Binding IsGitRepo}">
                    <Run Text="  •  Branch: "/>
                    <Run Text="{Binding CurrentBranch}"/>
                </TextBlock>
                <Border Grid.Column="4"/>
                <Button Grid.Column="5" x:Name="GitMenuButton" Foreground="#E6E6E6" IsVisible="{Binding IsGitRepo}">Git ▾
                    <Button.Flyout>
                        <MenuFlyout>
                            <MenuItem Header="Commit…" Click="OnGitCommitClick"/>
                            <MenuItem Header="New Branch…" Click="OnGitNewBranchClick"/>
                            <MenuItem Header="Switch Branch…" Click="OnGitSwitchBranchClick"/>
                            <MenuItem Header="Refresh" Click="OnGitRefreshClick"/>
                        </MenuFlyout>
                    </Button.Flyout>
                </Button>
                <Button Grid.Column="5" x:Name="InitGitButton" Foreground="#E6E6E6" IsVisible="{Binding CanInitGit}" Click="OnGitInitClick">Initialize Git…</Button>
                <Button Grid.Column="7" x:Name="OpenInFileManagerButton" Foreground="#E6E6E6" Click="OnOpenInFileManagerClick" IsEnabled="{Binding HasWorkspace}">Open in File Manager</Button>
                <Border Grid.Column="8"/>
                <Button Grid.Column="9" x:Name="OpenCliSettingsButton" Foreground="#E6E6E6" Click="OnOpenCliSettingsClick">CLI Settings</Button>
                <Border Grid.Column="10"/>
                <Button Grid.Column="11" x:Name="OpenAboutButton" Foreground="#E6E6E6" Click="OnOpenAboutClick">About</Button>
            </Grid>
        </Border>

        <!-- Body split: left file tree, right CLI output -->
        <Grid Grid.Row="1" ColumnDefinitions="320,Auto,*,Auto,*">
            <!-- Left: directory tree -->
            <Border BorderBrush="#333" BorderThickness="0,0,1,0" Background="#1F1F1F">
                <Grid RowDefinitions="Auto,*">
                    <TextBlock Margin="10,8" FontWeight="SemiBold" Text="Workspace Files" Foreground="#E6E6E6"/>
                    <TreeView x:Name="WorkspaceTree" Grid.Row="1" ItemsSource="{Binding TreeRoots}" SelectionChanged="OnTreeSelectionChanged">
                        <TreeView.DataTemplates>
                            <TreeDataTemplate DataType="models:FileTreeItem" ItemsSource="{Binding Children}">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <Path Width="14" Height="14"
                                          Data="{Binding IconGeometry}"
                                          Fill="{Binding StatusBrush}"/>
                                    <TextBlock Text="{Binding Name}" Foreground="#E6E6E6"/>
                                    <TextBlock Margin="6,0,0,0" Text="{Binding GitStatusShort}" Foreground="{Binding StatusBrush}"/>
                                </StackPanel>
                            </TreeDataTemplate>
                        </TreeView.DataTemplates>
                    </TreeView>
                </Grid>
            </Border>
            <!-- Splitter -->
            <GridSplitter Grid.Column="1" Width="5" Background="#2A2A2A" HorizontalAlignment="Stretch"
                          ResizeDirection="Columns" ShowsPreview="True"/>

            <!-- Middle: Editor / Compare pane -->
            <Grid x:Name="EditorPaneGrid" Grid.Column="2" RowDefinitions="Auto,*" SizeChanged="OnEditorPaneSizeChanged" ClipToBounds="True">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Top" Margin="10" Spacing="8">
                    <TextBlock FontWeight="SemiBold" Text="Editor"/>
                    <TextBlock Text="—"/>
                    <TextBlock TextTrimming="CharacterEllipsis" Text="{Binding SelectedFileName}"/>
                    <StackPanel x:Name="EditorButtonsPanel" Orientation="Horizontal" Spacing="6" Margin="20,0,0,0">
                        <Button x:Name="EditorViewCurrentButton" Click="OnEditorViewCurrentClick">Current File</Button>
                        <Button x:Name="EditorViewCompareButton" Click="OnEditorViewCompareClick">Compare with Git</Button>
                    </StackPanel>
                </StackPanel>

                <!-- Single editor panel -->
                <Grid x:Name="EditorSinglePanel" Grid.Row="1" Margin="10" RowDefinitions="Auto,*">
                    <!-- Small header with Save button -->
                    <Border Background="#1A1A1A" BorderBrush="#333" BorderThickness="1" CornerRadius="4,4,0,0" Padding="6,4">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button x:Name="SaveCurrentFileButton1" Click="OnSaveCurrentFileClick">Save</Button>
                        </StackPanel>
                    </Border>
                    <Border Grid.Row="1" BorderBrush="#555" BorderThickness="1" CornerRadius="0,0,4,4">
                        <ae:TextEditor x:Name="EditorCurrent"
                            Document="{Binding CurrentFileDocument, Mode=OneWay}"
                            IsReadOnly="False"
                            WordWrap="False"
                            ShowLineNumbers="True"
                            Background="#0A0A0A"
                            Foreground="#E6E6E6"
                            FontFamily="Consolas, Menlo, monospace"
                            FontSize="13" />
                    </Border>
                </Grid>

                <!-- Compare panel (side-by-side) -->
                <Grid x:Name="EditorComparePanel" Grid.Row="1" ColumnDefinitions="*,5,*" RowDefinitions="Auto,*" Margin="10" IsVisible="False">
                    <!-- Headers for alignment -->
                    <Border Grid.Column="0" Grid.Row="0" Background="#1A1A1A" BorderBrush="#333" BorderThickness="1" CornerRadius="4,4,0,0" Padding="6,4">
                        <TextBlock Text="Base (HEAD)" Foreground="#CCC"/>
                    </Border>
                    <Border Grid.Column="2" Grid.Row="0" Background="#1A1A1A" BorderBrush="#333" BorderThickness="1" CornerRadius="4,4,0,0" Padding="6,4">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button x:Name="SaveCurrentFileButton2" Click="OnSaveCurrentFileClick">Save</Button>
                            <TextBlock Text="Working Copy" Foreground="#CCC"/>
                        </StackPanel>
                    </Border>

                    <Border Grid.Column="0" Grid.Row="1" BorderBrush="#555" BorderThickness="1" CornerRadius="0,0,4,4">
                        <ae:TextEditor x:Name="EditorBase"
                            Document="{Binding BaseFileDocument, Mode=OneWay}"
                            IsReadOnly="True"
                            WordWrap="False"
                            ShowLineNumbers="True"
                            Background="#0A0A0A"
                            Foreground="#E6E6E6"
                            FontFamily="Consolas, Menlo, monospace"
                            FontSize="13" />
                    </Border>
                    <GridSplitter Grid.Column="1" Grid.Row="1" Width="5" Background="#2A2A2A" HorizontalAlignment="Stretch"
                                  ResizeDirection="Columns" ShowsPreview="True"/>
                    <Border Grid.Column="2" Grid.Row="1" BorderBrush="#555" BorderThickness="1" CornerRadius="0,0,4,4">
                        <ae:TextEditor x:Name="EditorCurrent2"
                            Document="{Binding CurrentFileDocument, Mode=OneWay}"
                            IsReadOnly="False"
                            WordWrap="False"
                            ShowLineNumbers="True"
                            Background="#0A0A0A"
                            Foreground="#E6E6E6"
                            FontFamily="Consolas, Menlo, monospace"
                            FontSize="13" />
                    </Border>
                </Grid>
            </Grid>

            <!-- Splitter between middle editor pane and right pane -->
            <GridSplitter Grid.Column="3" Width="5" Background="#2A2A2A" HorizontalAlignment="Stretch"
                          ResizeDirection="Columns" ShowsPreview="True"/>

            <!-- Right: CLI session area -->
            <Grid Grid.Column="4" RowDefinitions="Auto,*,Auto">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Top" Margin="10" Spacing="8">
                    <TextBlock FontWeight="SemiBold" Text="Codex CLI Session"/>
                    <TextBlock Text="—"/>
                    <TextBlock Text="{Binding SessionStatus}"/>
                    <ProgressBar Width="60" Height="6" IsIndeterminate="True" IsVisible="{Binding IsBusy}" Margin="8,0,0,0" Opacity="0.35"/>
                    <TextBlock Text="•" Margin="8,0,0,0"/>
                    <TextBlock Text="{Binding TokenStats}"/>
                </StackPanel>

                <Border Grid.Row="1" Margin="10" BorderBrush="#DDD" BorderThickness="1" CornerRadius="4">
                    <ae:TextEditor x:Name="LogEditor"
                        Document="{Binding CliLogDocument, Mode=OneWay}"
                        IsReadOnly="True"
                        WordWrap="True"
                        ShowLineNumbers="False"
                        Background="#0A0A0A"
                        Foreground="#E6E6E6"
                        FontFamily="Consolas, Menlo, monospace"
                        FontSize="13" />
                </Border>

                <StackPanel Grid.Row="2" Orientation="Vertical" Margin="10" Spacing="8">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button x:Name="RestartCliButton" Click="OnRestartCliClick" IsEnabled="{Binding HasWorkspace}">Restart Session</Button>
                        <Button x:Name="StopCliButton" Click="OnStopCliClick" IsEnabled="{Binding IsCliRunning}">Stop</Button>
                        <Button x:Name="ClearLogButton" Click="OnClearLogClick">Clear Log</Button>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBox HorizontalAlignment="Stretch" MinWidth="200" Watermark="Type input and press Enter"
                                 Text="{Binding CliInput, Mode=TwoWay}" KeyDown="OnCliInputKeyDown"/>
                        <Button x:Name="SendCliInputButton" Click="OnSendCliInputClick" IsEnabled="{Binding IsCliRunning}">Send</Button>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Grid>
    </Grid>
</Window>
